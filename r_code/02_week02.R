## ----setup_02, echo=FALSE, warning=FALSE, message=FALSE---------------------------------------------------------------------------------------------------------
library(tidyverse)
library(magrittr)
library(knitr)
library(kableExtra)
library(readstata13)
library(pander)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
print(is("a"))

print(str(TRUE))

print(class(123.45))

print(class(as.integer(1000)))

n <- as.numeric(999999999999999999999)

print(class(n))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# evaluate as logical, test whether 1 is greater than two
a <- 1 > 2

# create two numerical values, one being NA, representing ages
age_john <- 39
age_jane <- NA

# logical NA from Jane's undefined age
(jo <- age_john > 50)
(ja <- age_jane > 50)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
(t <- as.logical(1))
(f <- as.logical(0))


## ----int--------------------------------------------------------------------------------------------------------------------------------------------------------
i <- as.integer(999999999999999999999)

print(class(i))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
print(class("CafÃ©"))


## ----error=TRUE-------------------------------------------------------------------------------------------------------------------------------------------------
# this is a character
my_zip <- "98115"

# it is not numeric.
my_zip + 2

# we can convert it to numeric, although it would be silly to do with ZIP codes, which are nominal values
as.numeric(my_zip) + 2

# Boston has ZIP codes starting with zeros
boston_zip <- "02134"
as.numeric(boston_zip)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
print(charToRaw("z"))

class(charToRaw("z"))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# create a vector of length 1
a <- 1
is(a)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
c(1, "a", TRUE, charToRaw("z"))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
(c(1:3, TRUE, FALSE))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
c(1:3, TRUE, FALSE, "awesome!")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# a vector 
(v <- c(1, 3, 2))

(sort(v))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# create a random normal 
set.seed(5)
normvec1000 <- rnorm(n = 1000)

length(normvec1000)
class(normvec1000)
class(normvec1000 > 1)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
v <- seq(from = 0, to = 10, by = 2)
v[4]


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# make a vector 1 to 100
(v <- 1:100)

# load to a matrix
(m1 <- matrix(v, ncol = 10, byrow = TRUE))

# different r, c ordering
(m2 <- matrix(v, ncol = 10, byrow = FALSE))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
(m3 <- matrix(letters, ncol = 10, nrow = 10))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# a vector 1 to 27
v <- 1:27

# create an array, 3 x 3 x 3
(a <- array(v, dim = c(3, 3, 3)))

# array index is r, c, m (row, column, matrix), e.g., row 1 column 2 matrix 3:
(a[1,2,3])


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
(l <- list("a", 1, TRUE))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
(l <- list("a", 
           1:20, 
           as.logical(c(0,1,1,0))))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# show the data types
(lapply(X = l, FUN = class))

# mean, maybe?
(lapply(X = l, FUN = function(x) {mean(x)}))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
(income <- c("<$10,000"
, "$10,000-$49,999"
, "$50,000-$99,999"
, "$100,000-$200,000"
, ">$200,000"))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
sort(income)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# create a factor from income and set the levels
(income_factor <- factor(x = income, levels = income))

# sort again
(sort(income_factor))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# income levels 
inc <- c("<$10,000"
, "$10,000-$49,999"
, "$50,000-$99,999"
, "$100,000-$200,000"
, ">$200,000")

BMI <- 	data.frame(
   sid = c("A1001", "A1002", "B1001"),
   gender = c("Male", "Male","Female"), 
   height_cm = c(152, 171.5, 165), 
   weight_kg = c(81, 93, 78),
   age_y = c(42, 38, 26),
   income = factor(c("$50,000-$99,999", "$100,000-$200,000", "<$10,000"), levels = inc)
)
print(BMI)


## ----warning=FALSE----------------------------------------------------------------------------------------------------------------------------------------------
# read the dta file
dat <- readstata13::read.dta13("data/AHwave1_v1.dta")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
DT::datatable(data.frame(colname = names(dat), label = attributes(dat)$var.labels))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
head(iris)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
iris %>% head()


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
mean(iris[iris$Species == 'setosa', "Sepal.Length"])


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
iris %>% filter(Species == 'setosa') %>% summarize(mean(Sepal.Length))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# numeric tests
(1 == 2)

(1 == 3 - 2)

# character test (actually a factor)
(dat$imonth %>% head() %>% str_c(collapse = ", "))
((dat$imonth == "(6) June") %>% head())

# character test for multiple patterns
(dat$imonth %in% c("(6) June", "(7) July") %>% head())



## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
1 < 2

1 > 2

1 <= -10:10

1 >= -10:10


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
1 != 2

# those of the first 6 days that are not 14
(dat$iday %>% head())
((dat$iday != 14) %>% head())


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
dat$imonth %>% head(20)
((!dat$imonth %in% c("(6) June", "(7) July")) %>% head(20))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# first 20 records, fist 10 columns
dat_sub <- dat[1:20, 1:10]
kable(dat_sub, format = "html") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# from May
(dat_sub %>% filter(imonth == "(5) May"))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
(dat_sub %>% filter(imonth == "(5) May" & bio_sex == "(2) Female"))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
(dat_sub %>% filter(imonth == "(5) May" & (bio_sex == "(2) Female") | iday < 15))



## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# select 3 columns
(dat_sub_sel <- dat_sub %>%   
    select("aid", "imonth", "iday"))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# select all but two named columns
(dat_sub_sel <- dat_sub %>%   
    select(-"imonth", -"iday"))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# select columns by position and whose name matches a pattern, in this case the regular expression "^i" meaning "starts with lowercase i"
(dat_sub_sel <- dat_sub %>%   
    select(1, matches("^i")))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
#select one column, rename two columns
(dat_sub_sel %>% 
   select(aid, Month = imonth, Day = iday))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
(dat_sub_sel %>% 
   rename(Month = imonth, Day = iday))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# records with day of mongh > 15 and the first 3 named columns
(x <- dat_sub %>% 
    filter(iday > 15) %>%
    select(aid, imonth, iday)
   )


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# is this ordered?
is.ordered(dat$h1gi1m)

# what are the levels?
(levels(dat$h1gi1m))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# make birth month ordered
dat$h1gi1m <- factor(dat$h1gi1m, ordered = TRUE)

# now is it ordered?
is.ordered(dat$h1gi1m)

# perform the mutate() using the string representation of the factor for comparison
dat %>% 
    filter(iday > 15) %>%
    select(aid, imonth, iday, birth_month = h1gi1m) %>% 
    mutate(birth_1st_half = (birth_month < "(7) July")) %>% 
    head(20) %>% 
    kable() %>% 
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
(X <- dat_sub %>% 
     mutate(iday = -1000 + iday))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
dat_1 <- dat %>% 
    filter(iday > 15) %>%
    head(20) %>%
    select(aid, imonth, iday, birth_month = h1gi1m) %>% 
    mutate(birth_year_half = ifelse(test = birth_month < "(7) July", yes = "first", no = "last"))

# make that a factor
dat_1$birth_year_half <- factor(dat_1$birth_year_half, levels = c("first", "last"))
    
# print
kable(dat_1) %>% 
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
dat_1 %<>% 
    mutate(quarter = case_when(
        birth_month < "(3) March" ~ 1,
        birth_month < "(6) June" ~ 2,
        birth_month < "(9) September" ~ 3,
        TRUE ~ 4))

# print
kable(dat_1) %>% 
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
(dat_1 %<>% 
     mutate(birth_year_half_split = recode(birth_year_half,
                   "first" = "early",
                   "last" = "late")))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
dat %>% 
    filter(! str_detect(h1gi1y, "Refused")) %>% 
    mutate(yeari = str_replace_all(iyear, ".* ", "") %>% as.integer(),
           yearb = str_replace_all(h1gi1y, ".* ", "") %>% as.integer()) %>% 
    summarize(n = n(),
              mean_age = mean(yeari - yearb))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------
dat %>% 
    filter(! str_detect(h1gi1y, "Refused")) %>% 
    mutate(yeari = str_replace_all(iyear, ".* ", "") %>% as.integer(),
           yearb = str_replace_all(h1gi1y, ".* ", "") %>% as.integer()) %>% 
    group_by(bio_sex) %>% 
    summarize(mean_age = mean(yeari - yearb),
              sd_age = sd(yeari - yearb),
              n = n(),
              .groups = "drop_last") %>% 
    mutate(pct = prop.table(n) * 100)


## ----sourcecode_week02, comment='', echo=FALSE------------------------------------------------------------------------------------------------------------------
cat(readLines("02-week02.Rmd"), sep = '\n')

